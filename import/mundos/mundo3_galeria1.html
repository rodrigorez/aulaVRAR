<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- 🚀 Convertido para GitHub em 2025-09-29T18:21:57.930Z -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mundo J92 - Zonas 11 [29/09/2025, 14:58:08]</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <!-- 🌌 SISTEMA DE SHADERS MODULARES -->
  <script src="https://rodrigorez.github.io/aulaVRAR/import/shaders/base.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <a-scene
    cursor="rayOrigin: mouse"
    vr-mode-ui="enabled: true"
  >
    <!-- 📋 ASSETS: SISTEMA OFICIAL A-FRAME -->
    <a-assets>
      <img id="obra-texture-4" src="https://rodrigorez.github.io/aulaVRAR/import/assets/images/obra1.jpg" crossorigin="anonymous">
    </a-assets>
    
    <!-- 🖼️ FUNDO 360° COM SHADER DINÂMICO -->
    <a-sky id="sky-shader"></a-sky>

    <!-- 🎨 MÚltiplas Obras no Mundo VR (Grid Esférico Dinâmico) -->
    <a-box
        class="clickable-obra obra-4"
        position="0 1.6 -3" 
        width="1.8"
        height="1"
        depth="0.05"
        rotation="0 0 0"
        billboard="true"
        animation="property: position; dur: 1200; easing: easeInOutQuad; loop: true; dir: alternate"
        material="src: #obra-texture-4; transparent: false"
        shadow="cast: true; receive: true"
        data-url="https://rodrigorez.github.io/aulaVRAR/import/obras/obra4_mundo3.html"
      ></a-box>
    
    <!-- 🔴 Esfera para voltar à AR (POSIÇÃO DINÂMICA) -->
    <a-sphere
      id="botao-saida"
      class="clickable-back"
      position="0 1.6 -3"
      radius="0.4"
      color="#FF5252"
      billboard="true"
      animation="property: position; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"
    >
      <a-entity
        position="0 0.6 0"
        text="value: ↩️\nVOLTAR AR; align: center; color: white; width: 3"
        scale="1.2 1.2 1.2"
      ></a-entity>
    </a-sphere>

    <!-- 👁️ Câmera -->
    <a-entity camera look-controls wasd-controls position="0 1.6 0"></a-entity>
  </a-scene>

  <script>
    // 🌌 CONFIGURAÇÃO GRID ESFÉRICO (do config.json)
    const GRID_CONFIG = {
      centro: [0, 1.6, 0],
      raios: [3, 4, 5],
      angulos_horizontais: [-150, -120, -90, -60, -30, 0, 30, 60, 90, 120, 150, 180],
      angulos_verticais: [-30, 0, 30],
      animacao_offset: [0, 0.2, 0]
    };
    
    // ✅ FUNÇÃO: Converte coordenadas esféricas para cartesianas
    function esferaParaCartesiano(raio, anguloH, anguloV, centro) {
      const radH = (anguloH * Math.PI) / 180;
      const radV = (anguloV * Math.PI) / 180;
      
      const x = centro[0] + raio * Math.cos(radV) * Math.sin(radH);
      const y = centro[1] + raio * Math.sin(radV);
      const z = centro[2] + raio * Math.cos(radV) * Math.cos(radH);
      
      return [parseFloat(x.toFixed(1)), parseFloat(y.toFixed(1)), parseFloat(z.toFixed(1))];
    }
    
    // ✅ GERA TODAS AS POSIÇÕES DO GRID ESFÉRICO
    function gerarGridEsferico() {
      const posicoes = [];
      for (const raio of GRID_CONFIG.raios) {
        for (const anguloH of GRID_CONFIG.angulos_horizontais) {
          for (const anguloV of GRID_CONFIG.angulos_verticais) {
            const pos = esferaParaCartesiano(raio, anguloH, anguloV, GRID_CONFIG.centro);
            posicoes.push(pos);
          }
        }
      }
      return posicoes;
    }
    
    // ✅ RANDOMIZAÇÃO EM TEMPO REAL a cada reload
    function randomizarPosicoes() {
      const todasPosicoes = gerarGridEsferico();
      const posicoesUsadas = [];
      
      // Função para pegar posição aleatória única
      function pegarPosicaoAleatoria() {
        if (todasPosicoes.length === 0) return [0, 1.6, -3]; // Fallback
        const indice = Math.floor(Math.random() * todasPosicoes.length);
        return todasPosicoes.splice(indice, 1)[0];
      }
      
      // Posicionar botão de saída
      const posicaoBotao = pegarPosicaoAleatoria();
      const botaoSaida = document.getElementById('botao-saida');
      if (botaoSaida) {
        const posStr = `${posicaoBotao[0]} ${posicaoBotao[1]} ${posicaoBotao[2]}`;
        const animStr = `${posicaoBotao[0]} ${posicaoBotao[1] + GRID_CONFIG.animacao_offset[1]} ${posicaoBotao[2]}`;
        botaoSaida.setAttribute('position', posStr);
        botaoSaida.setAttribute('animation', `property: position; to: ${animStr}; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate`);
      }
      
      // Posicionar obras
      const obras = document.querySelectorAll('.clickable-obra');
      obras.forEach(obra => {
        const posicaoObra = pegarPosicaoAleatoria();
        const posStr = `${posicaoObra[0]} ${posicaoObra[1]} ${posicaoObra[2]}`;
        const animStr = `${posicaoObra[0]} ${posicaoObra[1] + GRID_CONFIG.animacao_offset[1]} ${posicaoObra[2]}`;
        obra.setAttribute('position', posStr);
        obra.setAttribute('animation', `property: position; to: ${animStr}; dur: 1200; easing: easeInOutQuad; loop: true; dir: alternate`);
      });
      
      console.log('✅ Posições randomizadas:', {
        botao: posicaoBotao,
        obras: Array.from(obras).map(o => o.getAttribute('position')),
        total_disponivel: todasPosicoes.length + obras.length + 1
      });
    }

    AFRAME.registerComponent('redirect-on-click', {
      schema: { url: { type: 'string', default: '#' } },
      init: function () {
        const el = this.el;
        const url = this.data.url;

        el.addEventListener('click', () => {
          el.setAttribute('scale', '1.2 1.2 1.2');
          setTimeout(() => {
            window.location.href = url;
          }, 300);
        });
      }
    });

    // 🎯 COMPONENTE BILLBOARD: Rotaciona apenas no eixo Y (sem inclinações)
    AFRAME.registerComponent('billboard', {
      schema: {
        enabled: { type: 'boolean', default: true }
      },
      
      init: function () {
        this.camera = null;
      },
      
      tick: function () {
        if (!this.data.enabled) return;
        
        // Busca câmera na primeira execução
        if (!this.camera) {
          this.camera = document.querySelector('[camera]');
          if (!this.camera) return;
        }
        
        const targetPosition = this.camera.getAttribute('position');
        const currentPosition = this.el.getAttribute('position');
        
        // Calcula ângulo apenas no plano horizontal (eixo Y)
        const dx = targetPosition.x - currentPosition.x;
        const dz = targetPosition.z - currentPosition.z;
        const angleY = Math.atan2(dx, dz) * (180 / Math.PI);
        
        // Aplica rotação apenas no eixo Y (mantém obra "em pé")
        this.el.setAttribute('rotation', { x: 0, y: angleY, z: 0 });
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // ✅ CARREGA SHADER ESPECÍFICO DO MUNDO
      const idMundo = '3';
      carregarShaderMundo(idMundo);
      
      // ✅ RANDOMIZA POSIÇÕES IMEDIATAMENTE AO CARREGAR
      randomizarPosicoes();
      
      const sphere = document.querySelector('.clickable-back');
      if (sphere) {
        sphere.setAttribute('redirect-on-click', {
          url: 'https://rodrigorez.github.io/aulaVRAR/import/galerias/galeria1.html'
        });
      }

      // 🎨 SISTEMA MÚltiplas Obras - Click handler dinâmico
      const obras = document.querySelectorAll('.clickable-obra');
      obras.forEach(obra => {
        const url = obra.getAttribute('data-url');
        if (url) {
          obra.setAttribute('redirect-on-click', { url: url });
        }
      });
    });
  </script>
</body>
</html>